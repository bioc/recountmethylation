---
title: "recountmethylation Bioconductor vignette"
author: 
  - name: Sean K. Maden
  - name: Reid F. Thompson
  - name: Kasper D. Hansen
  - name: Abhi Nellore
package: recountmethylation
date: "4/4/2020"
abstract: > 
  This is the main vignette for the `recountmethylation` package.
vignette: >
    %\VignetteDepends{RCurl}
    %\VignetteEngine{knitr::knitr} 
    %\VignetteIndexEntry{bioc_vignette} 
    %\usepackage[UTF-8]{inputenc}
output:
    BiocStyle::html_document:
        toc: true
        tocfloat: true
        code_folding: show
    pdf_document: default
---

```{r setup}
library(recountmethylation)
library(HDF5Array)
library(minfi)
knitr::opts_chunk$set(eval = TRUE, echo = TRUE, 
                      warning = FALSE, message = FALSE)
```

# Overview

DNAm assay data and sample metadata available as of March 2019 were 
piped into HDF5-based SummarizedExperiment objects about 80 to 130Gb in size.

# Server queries

Queries to `recount.bio/data` can be handled using `get_rmdl()`. Targeted data are specified by setting `which.dn`. For instance, the test dataset may be downloaded using `get_rmdl("h5se_gr", verbose = FALSE)`, which generates a new directory containing `assays.h5` and `se.rds`. For convenience, `get_rmdl` returns the filepath, and this may be used in `loadHDF5SummarizedExperiment` at the start of an analysis workflow.

Assay data are contained in the following directories:

* `remethdb_h5se_gm_00-00-01_1583780004` (class: `GenomicMethylSet`, size: 86 Gb)
* `remethdb_h5se_gr_00-00-01_1583780004` (class: `GenomicRanges`, size: 132 Gb)
* `remethdb_h5se_rg_00-00-01_1583780004` (class: `RGChannelSet`, size: 119 Gb)

# DelayedArray workflows 

Ideal workflows utilizing large DelayedArray objects will delay evaluations until absolutely necessary. In the following example loading a large dataset at `h5fullsizepath`, the DNAm Beta-values aren't retrieved from the `DelayedArray` object until `summarize` is called on the first column.

```{r, eval = FALSE}
h5large <- loadHDF5SummarizedExperiment(h5fullsizepath)
betamatrix <- getBeta(h5large) # this is delayed 
summarize(betamatrix[,1]) # causes getBeta evaluation
```

See the below example and `dasupport.Rmd` vignette for details.

# Example

For demonstration, load the included test dataset. First, get the path to the test data directory and note its contents.

```{r testdatpath}
testdatdn <- "remethdb_h5se-test_gr_00-00-01_1583780004"
datpath <- system.file("extdata", testdatdn, package = "recountmethylation")
print("files in data directory")
list.files(datpath)
```

Next, load the data and summarize. Standard inspection and summary functions may be used.

```{r, testdat.dl}
h5test <- loadHDF5SummarizedExperiment(datpath)

print("dimensions")
dim(h5test)

print("class")
class(h5test)

print("head of colnames")
head(colnames(h5test))

print("head of rownames")
head(rownames(h5test))
```

Probe annotations are retrieved using `getAnnotation`.

```{r}
chr <- names(table(getAnnotation(h5test)$chr))
min.pos <- min(getAnnotation(h5test)$pos)
min.pos <- max(getAnnotation(h5test)$pos)

print("genome coords:")
print(paste0(chr, ":", min.pos, "-", min.pos))
```

Phenotype and experiment are retrieved using `pData`.

```{r}
pdat <- pData(h5test)

print("class")
class(pdat)

print("dimensions")
dim(pdat)

print("colnames")
colnames(pdat)
```

Finally, DNAm Beta-values are accessed using `getBeta`. Note the class change when `as.matrix` is called.

```{r}
bdelay <- getBeta(h5test)
bmatrix <- as.matrix(bval)

print("dim output on DelayedArray: ")
print(dim(bdelay))

print("dim output on matrix: ")
print(dim(bmatrix))

print("summary output on DelayedArray: ")
print(summary(bdelay))

print("summary output on matrix: ")
print(summary(bmatrix))
```

Note that `DelayedArray` objects may not work as expected before a new data format is specified, such as with the following example using `summarize`.

```{r}
summary(bval)
summary(bm)
```

# Session info
```{r}
sessionInfo()
```
