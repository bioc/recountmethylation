---
title: "recountmethylation Bioconductor vignette"
author: 
  - name: Sean K. Maden
  - name: Reid F. Thompson
  - name: Kasper D. Hansen
  - name: Abhi Nellore
package: recountmethylation
date: "4/4/2020"
abstract: > 
  This is the main vignette for the `recountmethylation` package.
vignette: >
    %\VignetteDepends{RCurl}
    %\VignetteIndexEntry{bioc_vignette} 
    %\usepackage[UTF-8]{inputenc}
    %\VignetteEngine{knitr::knitr} 
output:
    pdf_document: default
    BiocStyle::html_document:
        toc: true
        tocfloat: true
        code_folding: show
---

# Overview

Note the disclaimer when loading recountmethylation.

```{r setup, echo = FALSE}
suppressMessages(library(HDF5Array))
suppressMessages(library(minfi))
knitr::opts_chunk$set(eval = TRUE, echo = TRUE, 
                      warning = FALSE, message = FALSE)
# recountmethylation
library(recountmethylation)
```

DNAm assay data and sample metadata available as of March 2019 were 
piped into the following HDF5-based SummarizedExperiment objects:

* `remethdb_h5se_gm_00-00-01_1583780004` (class: `GenomicMethylSet`, size: 86 Gb)
* `remethdb_h5se_gr_00-00-01_1583780004` (class: `GenomicRanges`, size: 132 Gb)
* `remethdb_h5se_rg_00-00-01_1583780004` (class: `RGChannelSet`, size: 119 Gb)

# Server queries

Queries to `recount.bio/data` can be handled using `get_rmdl()`. Targeted data are specified by setting `which.dn`. For instance, the test dataset may be downloaded using `get_rmdl("h5se_gr", verbose = FALSE)`, which generates a new directory containing `assays.h5` and `se.rds`. For convenience, `get_rmdl` returns the filepath, and this may be used in `loadHDF5SummarizedExperiment` at the start of an analysis workflow.

# DelayedArray workflows 

Ideal workflows utilizing large `DelayedArray` objects will delay evaluations until absolutely necessary. In the following example loading a large dataset at `h5fullsizepath`, the DNAm Beta-values aren't retrieved from the `DelayedArray` object until `summarize` is called on the first column.

```{r, eval = FALSE}
h5large <- loadHDF5SummarizedExperiment(h5fullsizepath)
betamatrix <- getBeta(h5large) # this is delayed 
summarize(betamatrix[,1]) # causes getBeta evaluation
```

# Example

This example illustrates how to load and handle the full-sized `recountmethylation` assay data objects. First, get the path to the test data directory and note its contents.

```{r testdatpath}
testdatdn <- "remethdb_h5se-test_gr_00-00-01_1583780004"
datpath <- system.file("extdata", testdatdn, package = "recountmethylation")
```
```{r, echo = FALSE}
print("files in data directory:")
list.files(datpath)
```

Next, load the data with `loadHDF5SummarizedExperiment` and inspect.

```{r, testdat.dl, echo = FALSE}
h5test <- loadHDF5SummarizedExperiment(datpath)
print("dimensions:")
dim(h5test)
print("class:")
class(h5test)
print("head of colnames:")
head(colnames(h5test))
print("head of rownames:")
head(rownames(h5test))
```

As with standard `SummarizedExperiment` objects, assay annotations are retrieved using `getAnnotation`.

```{r}
chr <- names(table(getAnnotation(h5test)$chr))
min.pos <- min(getAnnotation(h5test)$pos)
min.pos <- max(getAnnotation(h5test)$pos)
print(paste0(chr, ":", min.pos, "-", min.pos))
```

Similarly, sample and experiment data are retrieved using `pData`.

```{r, echo = FALSE}
pdat <- pData(h5test)
print("class:")
class(pdat)
print("dimensions:")
dim(pdat)
print("colnames:")
colnames(pdat)
```

Finally, DNAm Beta-values are accessed using `getBeta`. As mentioned above, `DelayedArray` objects may not work as expected before operations such as class definitions or subsets are declared. Below this is demonstrated using `dim` and `summarize`.

```{r}
bdelay <- getBeta(h5test)
bmatrix <- as.matrix(bdelay)
identical(dim(bdelay), dim(bmatrix))
identical(summary(bdelay), summary(bmatrix))
```

You may consult the `dasupport.Rmd` vignette for more extensive examples making use of `DelayedArray` objects for methylation analysis.

# Session info
```{r}
sessionInfo()
```
